!function(t){var n={};function e(i){if(n[i])return n[i].exports;var r=n[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,e),r.l=!0,r.exports}e.m=t,e.c=n,e.d=function(t,n,i){e.o(t,n)||Object.defineProperty(t,n,{enumerable:!0,get:i})},e.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e.t=function(t,n){if(1&n&&(t=e(t)),8&n)return t;if(4&n&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(e.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&n&&"string"!=typeof t)for(var r in t)e.d(i,r,function(n){return t[n]}.bind(null,r));return i},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,n){return Object.prototype.hasOwnProperty.call(t,n)},e.p="",e(e.s=0)}([function(t,n,e){e(1)},function(t,n,e){"use strict";function i(t){return t.x*t.x+t.y*t.y}function r(t){return Math.sqrt(i(t))}function o(t,n){return{x:t.x-n.x,y:t.y-n.y}}function s(t,n){return{x:t.x*n,y:t.y*n}}function a(t){return s(t,1/r(t))}function c(t,n){return{x:t.x+n.x,y:t.y+n.y}}function u(t,n){return t.slice(t.findIndex(t=>!n(t)))}function l(t,n=.5){const e=n*n;return t.reduce((function(t,n){return 0===t.length?[n]:t.slice(0,-1).concat(function(t,n){return i(o(t[t.length-1],n[0]))<=e?[t.concat(u(n,n=>i(o(t[t.length-1],n))<=e))]:[t,n]}(t[t.length-1],n))}),[])}function p(t,n){return t.filter(t=>function(t){if(t.length<=1)return 0;let n=0,e=t[0];for(let i=1;i<t.length;i++)n+=r(o(e,t[i])),e=t[i];return n}(t)>=n)}function h(t,n=2){return{x:Number(t.x.toFixed(n)),y:Number(t.y.toFixed(n))}}e.r(n);class f{constructor(t){this.size=t}get landscape(){return new f({x:Math.max(this.size.x,this.size.y),y:Math.min(this.size.x,this.size.y)})}get portrait(){return new f({x:Math.min(this.size.x,this.size.y),y:Math.max(this.size.x,this.size.y)})}get isLandscape(){return this.size.x===Math.max(this.size.x,this.size.y)}}f.standard={USLetter:new f(h(s({x:8.5,y:11},25.4))),USLegal:new f(h(s({x:8.5,y:14},25.4))),ArchA:new f(h(s({x:9,y:12},25.4))),A3:new f({x:297,y:420}),A4:new f({x:210,y:297}),A5:new f({x:148,y:210}),A6:new f({x:105,y:148}),"6x8":new f(h(s({x:6,y:8},25.4))),"5x7":new f(h(s({x:5,y:7},25.4))),"11x14":new f(h(s({x:11,y:14},25.4)))};f.standard.ArchA.landscape,new Set,new Set;const x={Axidraw:{stepsPerMm:5,penServoMin:7500,penServoMax:28e3,penPctToPos(t){const n=t/100;return Math.round(this.penServoMin*n+this.penServoMax*(1-n))}}};x.Axidraw.stepsPerMm,x.Axidraw.stepsPerMm,x.Axidraw.stepsPerMm,x.Axidraw.stepsPerMm,x.Axidraw.stepsPerMm,x.Axidraw.penPctToPos(50),x.Axidraw.penPctToPos(60);class d{constructor(t,n,e,i,s){if(!(e>=0))throw new Error("vInitial must be >= 0, but was "+e);if(!(e+t*n>=-1e-9))throw new Error(`vFinal must be >= 0, but vInitial=${e}, duration=${n}, accel=${t}`);this.accel=t,this.duration=n,this.vInitial=e,this.p1=i,this.p2=s,this.distance=r(o(i,s))}static deserialize(t){return new d(t.accel,t.duration,t.vInitial,t.p1,t.p2)}get vFinal(){return Math.max(0,this.vInitial+this.accel*this.duration)}instant(t,n=0,e=0){const i=Math.max(0,Math.min(this.duration,t)),r=this.accel,u=this.vInitial+this.accel*i,l=Math.max(0,Math.min(this.distance,this.vInitial*i+r*i*i/2));return{t:i+n,p:c(this.p1,s(a(o(this.p2,this.p1)),l)),s:l+e,v:u,a:r}}serialize(){return{accel:this.accel,duration:this.duration,vInitial:this.vInitial,p1:this.p1,p2:this.p2}}}class y{constructor(t,n,e){this.initialPos=t,this.finalPos=n,this.pDuration=e}static deserialize(t){return new y(t.initialPos,t.finalPos,t.duration)}duration(){return this.pDuration}serialize(){return{t:"PenMotion",initialPos:this.initialPos,finalPos:this.finalPos,duration:this.pDuration}}}function m(t,n,e){const i=[];let r=n;i.push(r);for(const n of t)r=e(r,n),i.push(r);return i}class w{constructor(t){this.blocks=t,this.ts=m(t.map(t=>t.duration),0,(t,n)=>t+n).slice(0,-1),this.ss=m(t.map(t=>t.distance),0,(t,n)=>t+n).slice(0,-1)}static deserialize(t){return new w(t.blocks.map(d.deserialize))}get p1(){return this.blocks[0].p1}get p2(){return this.blocks[this.blocks.length-1].p2}duration(){return this.blocks.map(t=>t.duration).reduce((t,n)=>t+n,0)}instant(t){const n=function(t,n){let e=0,i=t.length;for(;e<i;){const r=Math.floor((e+i)/2);t[r]<n?e=r+1:i=r}return e}(this.ts,t),e=this.ts[n]===t?n:n-1;return this.blocks[e].instant(t-this.ts[e],this.ts[e],this.ss[e])}serialize(){return{t:"XYMotion",blocks:this.blocks.map(t=>t.serialize())}}}class g{constructor(t){this.motions=t}static deserialize(t){return new g(t.motions.map(t=>{switch(t.t){case"XYMotion":return w.deserialize(t);case"PenMotion":return y.deserialize(t)}}))}duration(){return this.motions.map(t=>t.duration()).reduce((t,n)=>t+n,0)}motion(t){return this.motions[t]}withPenHeights(t,n){let e=0;return new g(this.motions.map((i,r)=>i instanceof w?i:i instanceof y?r===this.motions.length-3?new y(n,x.Axidraw.penPctToPos(0),i.duration()):r===this.motions.length-1?new y(x.Axidraw.penPctToPos(0),t,i.duration()):e++%2==0?new y(t,n,i.duration()):new y(n,t,i.duration()):void 0))}serialize(){return{motions:this.motions.map(t=>t.serialize())}}}class P{constructor(t,n){this.maxEntryVelocity=0,this.entryVelocity=0,this.p1=t,this.p2=n,this.blocks=[]}length(){return r(o(this.p2,this.p1))}direction(){return a(o(this.p2,this.p1))}}function M(t,n,e,i,r,u){const l=(2*i*t+e*e-n*n)/(4*i),p=t-l,h=Math.sqrt(n*n+2*i*l);return{s1:l,s2:p,t1:(h-n)/i,t2:(e-h)/-i,vMax:h,p1:r,p2:c(r,s(a(o(u,r)),l)),p3:u}}function b(t,n,e,i,r,u,l){const p=(e-n)/r,h=(e+n)/2*p,f=(i-e)/-r,x=(i+e)/2*f,d=t-h-x,y=d/e,m=a(o(l,u));return{s1:h,s2:d,s3:x,t1:p,t2:y,t3:f,p1:u,p2:c(u,s(m,h)),p3:c(u,s(m,t-x)),p4:l}}function z(t,n){const e=function(t,n){if(0===n)return t;const e=[];e.push(t[0]);for(const i of t.slice(1))r(o(i,e[e.length-1]))>n&&e.push(i);return e}(t,1e-9);if(1===e.length)return new w([new d(0,0,0,e[0],e[0])]);const i=e.slice(1).map((t,n)=>new P(e[n],t)),s=n.acceleration,a=n.maximumVelocity,c=n.corneringFactor;i.slice(1).forEach((t,n)=>{const e=i[n];t.maxEntryVelocity=function(t,n,e,i,r){const o=(s=t.direction(),a=n.direction(),-(s.x*a.x+s.y*a.y));var s,a;if(Math.abs(o-1)<1e-9)return 0;const c=Math.sqrt((1-o)/2);if(Math.abs(c-1)<1e-9)return e;const u=Math.sqrt(i*r*c/(1-c));return Math.min(u,e)}(e,t,a,s,c)});const u=e[e.length-1];i.push(new P(u,u));let l=0;for(;l<i.length-1;){const t=i[l],n=i[l+1],e=t.length(),r=t.entryVelocity,o=n.maxEntryVelocity,c=t.p1,u=t.p2,p=M(e,r,o,s,c,u);if(p.s1<-1e-9)t.maxEntryVelocity=Math.sqrt(o*o+2*s*e),l-=1;else if(p.s2<=0){const i=Math.sqrt(r*r+2*s*e),o=(i-r)/s;t.blocks=[new d(s,o,r,c,u)],n.entryVelocity=i,l+=1}else if(p.vMax>a){const i=b(e,r,a,o,s,c,u);t.blocks=[new d(s,i.t1,r,i.p1,i.p2),new d(0,i.t2,a,i.p2,i.p3),new d(-s,i.t3,a,i.p3,i.p4)],n.entryVelocity=o,l+=1}else t.blocks=[new d(s,p.t1,r,p.p1,p.p2),new d(-s,p.t2,p.vMax,p.p2,p.p3)],n.entryVelocity=o,l+=1}const p=[];return i.forEach(t=>{t.blocks.forEach(t=>{t.duration>1e-9&&p.push(t)})}),new w(p)}function v(t,n,e){return function(t,n,e){const[i,r]=function(t){let n=-1/0,e=-1/0,i=1/0,r=1/0;for(const o of t)for(const t of o)t.x>n&&(n=t.x),t.y>e&&(e=t.y),t.x<i&&(i=t.x),t.y<r&&(r=t.y);return[{x:i,y:r},{x:n,y:e}]}(t),a=e.x-n.x,u=e.y-n.y,l=a/(r.x-i.x),p=u/(r.y-i.y),h=Math.min(l,p),f=c(n,s(o(e,n),.5)),x=o(f,s(o(r,i),.5*h));return t.map(t=>t.map(t=>c(s(o(t,i),h),x)))}(t,{x:e,y:e},o(n.size,{x:e,y:e}))}function A(t,n){const[e,i]=t,[r,a]=n,u=o(a,r),l=[-u.x,u.x,-u.y,u.y],p=[r.x-e.x,i.x-r.x,r.y-e.y,i.y-r.y];var h=-1/0,f=1/0;for(let t=0;t<4;t++)if(0==l[t]){if(p[t]<0)return null}else{const n=p[t]/l[t];l[t]<0&&h<n?h=n:l[t]>0&&f>n&&(f=n)}return h>f||h>1||h<0?null:c(r,s(u,h))}function D(t,n){const[e,i]=t;return n.x>=e.x&&n.x<=i.x&&n.y>=e.y&&n.y<=i.y}function k(t,n){const[e,i]=n,r=D(t,e),o=D(t,i);if(r&&o)return n;if(r&&!o)return[n[0],A(t,[n[1],n[0]])];if(!r&&o)return[A(t,n),n[1]];const s=A(t,n),a=A(t,[n[1],n[0]]);return s&&a?[s,a]:null}function S(t,n){const e=[];let i=null;for(let r=1;r<t.length;r++){const[o,s]=[t[r-1],t[r]],a=k(n,[o,s]);a?(i||(i=[a[0]],e.push(i)),i.push(a[1]),a[1]!==s&&(i=null)):i=null}return e}function E(t,n){let e=t;n.fitPage?e=v(e,n.paperSize,n.marginMm):(e=e.map(t=>t.map(t=>s(t,25.4/96))),n.cropToMargins&&(e=function(t,n,e){const i=[{x:0,y:0},n.size],r={x:e,y:e},s=[c(i[0],r),o(i[1],r)],a=[];for(const n of t)for(const t of S(n,s))a.push(t);return a}(e,n.paperSize,n.marginMm))),"group"===n.layerMode?e=e.filter((e,i)=>n.selectedGroupLayers.has(t[i].groupId)):"stroke"===n.layerMode&&(e=e.filter((e,i)=>n.selectedStrokeLayers.has(t[i].stroke))),n.pointJoinRadius>0&&(e=e.map(t=>function(t,n){if(0===n)return t;const e=[t[0]],r=n*n;for(const n of t.slice(1))i(o(n,e[e.length-1]))>r&&e.push(n);return e}(t,n.pointJoinRadius))),n.sortPaths&&(console.time("sorting paths"),e=function(t){if(0===t.length)return t;function n(n,e){if(n===e)return 0;const i=t[n/2|0],r=t[e/2|0],o=n%2==0?i[i.length-1]:i[0],s=e%2==0?r[0]:r[r.length-1],a=o.x-s.x,c=o.y-s.y;return a*a+c*c}const e=new Set;for(let n=0;n<t.length;n++)e.add(n);const i=[];let r=0;for(e.delete(r),i.push(t[r]);e.size>0;){let o=null,s=1/0;for(const t of e)for(let e=0;e<2;e++){const i=n(r,2*t+e);i<s&&(s=i,o=2*t+e)}e.delete(o/2|0),i.push(o%2==0?t[o/2|0]:t[o/2|0].slice().reverse()),r=o}return i}(e),console.timeEnd("sorting paths")),n.minimumPathLength>0&&(console.time("eliding short paths"),e=p(e,n.minimumPathLength),console.timeEnd("eliding short paths")),n.pathJoinRadius>0&&(console.time("joining nearby paths"),e=l(e,n.pathJoinRadius),console.timeEnd("joining nearby paths")),e=e.map(t=>t.map(t=>s(t,x.Axidraw.stepsPerMm))),console.time("planning pen motions");const r=function(t,n){const e=[];let i={x:0,y:0};return t.forEach((r,o)=>{const s=z(r,n.penDownProfile),a=o===t.length-1?x.Axidraw.penPctToPos(0):n.penUpPos;e.push(z([i,s.p1],n.penUpProfile),new y(n.penUpPos,n.penDownPos,n.penDropDuration),s,new y(n.penDownPos,a,n.penLiftDuration)),i=s.p2}),e.push(z([i,{x:0,y:0}],n.penUpProfile)),e.push(new y(x.Axidraw.penPctToPos(0),n.penUpPos,n.penDropDuration)),new g(e)}(e,{penUpPos:x.Axidraw.penPctToPos(n.penUpHeight),penDownPos:x.Axidraw.penPctToPos(n.penDownHeight),penDownProfile:{acceleration:n.penDownAcceleration*x.Axidraw.stepsPerMm,maximumVelocity:n.penDownMaxVelocity*x.Axidraw.stepsPerMm,corneringFactor:n.penDownCorneringFactor*x.Axidraw.stepsPerMm},penUpProfile:{acceleration:n.penUpAcceleration*x.Axidraw.stepsPerMm,maximumVelocity:n.penUpMaxVelocity*x.Axidraw.stepsPerMm,corneringFactor:0},penDropDuration:n.penDropDuration,penLiftDuration:n.penLiftDuration});return console.timeEnd("planning pen motions"),r}self.addEventListener("message",t=>{const{paths:n,planOptions:e}=t.data,i=E(n,e);console.time("serializing");const r=i.serialize();console.timeEnd("serializing"),self.postMessage(r)});n.default={}}]);
//# sourceMappingURL=55264288e88cd96aab13.worker.js.map